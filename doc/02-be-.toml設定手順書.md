# Back-End wrangler.toml設定手順書

### ※この手順書はnpm run dev:wranglerで起動するCloudflare Workers用です。

## 概要
wrangler.toml設定手順書です。

## 設定ファイル構成

- `wrangler.toml` - メイン設定ファイル ←（コミットする）
- `wrangler.example.toml` - 設定例 ←（サンプル）

## TOMLファイルとは
- **TOML** = Tom's Obvious Minimal Language
- Cloudflare Workersの標準設定形式
- Rustプロジェクトでも広く使用

## 設定手順
※CORS-ORIGIN設定などを行う際のローカルipの調べ方です。（現状飛ばしても可）

### 0. IPアドレスの確認

まず、自分のPCのIPアドレスを確認します：

#### Windows
```bash
# IPアドレスを確認
ipconfig
```

**実行結果例:**
```
Windows IP 構成

イーサネット アダプター イーサネット:
   メディアの状態. . . . . . . . . . . .: メディアが接続されていません

Wi-Fi アダプター Wi-Fi:
   接続固有の DNS サフィックス. . . . .:
   IPv4 アドレス . . . . . . . . . . . .: 192.168.10.50　←これ
   サブネット マスク . . . . . . . . . .: 255.255.255.0
   デフォルト ゲートウェイ . . . . . . .: 192.168.10.1
```

#### macOS/Linux
```bash
# IPアドレスを確認
ifconfig

# または
ip addr show
```

**実行結果例:**
```
wlan0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
　これ→ inet 192.168.10.50  netmask 255.255.255.0  broadcast 192.168.10.255
        ether 00:11:22:33:44:55  txqueuelen 1000  (Ethernet)
```

**確認のポイント:**
- WiFi接続の場合：`Wi-Fi`または`wlan0`のIPv4アドレス
- 有線接続の場合：`イーサネット`または`eth0`のIPv4アドレス
- 通常 `192.168.x.x` や `10.x.x.x` の形式

**重要:**
- `192.168.10.50` の部分は、先ほど確認した自分のIPアドレスに変更してください
- スマホからアクセスする場合、このIPアドレスが必要になります

### 1. 基本設定

#### `wrangler.toml` (メイン設定)
```toml
name = "rec-time-be"
main = "src/index.ts"
#nodeライブラリ互換フラグ
compatibility_flags = [ "nodejs_compat" ]
compatibility_date = "2024-09-23"

# ローカル開発用の設定
[env.development]
vars = { NODE_ENV = "development"}

# 本番用D1データベース設定（後で設定）
[[d1_databases]]
binding = "DB"
database_name = "rectime"
database_id = "de999791-7919-4866-ae7c-79a83d083578"

```

### 2. 環境別起動方法

#### 開発環境
```bash
# デフォルト（development環境）
npm run dev:wrangler
```

#### ステージング環境
```bash
wrangler dev --env staging
```

#### 本番環境
```bash
# 本番デプロイ
wrangler deploy --env production

# 本番環境での動作確認
wrangler dev --env production
```

### 3. 設定例ファイル

#### `wrangler.example.toml` (設定例)
```toml
name = "your-project-name"
main = "src/index.ts"
compatibility_flags = ["nodejs_compat"]
compatibility_date = "2024-09-23"

# 開発環境設定
[env.development]
vars = { NODE_ENV = "development", API_URL = "https://localhost:8787",  DEBUG = "true", YOUR_API_KEY = "your-api-key-here" }

# 本番環境設定
[env.production]
vars = { NODE_ENV = "production", API_URL = "https://your-domain.com",  DEBUG = "false", LOG_LEVEL = "info", YOUR_API_KEY = "your-production-api-key", CORS_ORIGINS = "https://localhost:5173,https://192.168.10.50:5173" }

# 開発環境用D1データベース
[[env.development.d1_databases]]
binding = "DB"
database_name = "your-database-dev"
database_id = "your-dev-database-id"

# 本番環境用D1データベース
[[env.production.d1_databases]]
binding = "DB"
database_name = "your-database-prod"
database_id = "your-prod-database-id"
```

#### コード内での使用方法
```typescript
// src/index.ts
export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const apiUrl = env.API_URL;
    const debug = env.DEBUG === "true";

    if (debug) {
      console.log("Debug mode enabled");
    }

    return new Response("Hello World");
  }
}
```

### 4. CORS設定

#### CORS許可オリジンの設定
```toml
[env.development]
vars = { CORS_ORIGINS = "https://localhost:5173,https://your-ip-address:5173" }

[env.production]
vars = { CORS_ORIGINS = "https://your-frontend-domain.com" }
```

### 5. 動作確認

#### 設定の確認
```bash
# 現在の設定を確認
wrangler whoami

# 環境変数の確認（開発環境）
wrangler dev --env development

# 環境変数の確認（本番環境）
wrangler dev --env production
```

#### APIエンドポイントテスト
```bash
# 開発環境
curl https://localhost:8787/

# 本番環境（デプロイ後）
curl https://your-worker.your-subdomain.workers.dev/
```



**注意：**
- `wrangler.toml`は通常コミットする
- 機密情報は絶対にwrangler.tomlに直接書かない

## 参考情報

- **Wrangler公式ドキュメント**: https://developers.cloudflare.com/workers/wrangler/
- **TOML仕様**: https://toml.io/
- **Cloudflare D1**: https://developers.cloudflare.com/d1/
- **Environment Variables**: https://developers.cloudflare.com/workers/platform/environment-variables/

---

**最終更新**: 2025年9月22日